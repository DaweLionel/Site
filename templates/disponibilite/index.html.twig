{% extends 'base2.html.twig' %}

{% block title %}Disponibilite{% endblock %}

{% block body %}

<style>
    body {
        font-family: Arial, sans-serif;
        
    }

    h1 {
        text-align: center;
    }

    #dates-container,
    #time-slots-container {
        margin-top: 20px;
    }
    #dates-container{
        cursor: pointer;
    }

    .time-slot {
        margin-left: 20px;
    }
</style>


<div class="container">
    
<h1>Gestion des Disponibilités</h1>
<div class="mb-3">
    <form id="date-form">
        <label class="form-label" for="date">Date:</label>
        <input type="date" id="date" name="date" class="form-control" style="width: 95%;" required>
        <button  type="submit" class="btn btn-primary mt-2">Ajouter Date</button>
    </form>
</div>

<div id="dates-container"></div>
<div id="time-slots-form-container">
    <form id="time-slot-form">
        <input type="hidden" id="date-id" name="date-id">
        <div class="mb-3">
        <label for="start-time">Heure de début:</label>
        <input style="width: 95%;" class="form-control" type="time" id="start-time" name="start-time" required>
        </div>
        <div class="mb-3">
            <label for="end-time">Heure de fin:</label>
            <input style="width: 95%;" class="form-control" type="time" id="end-time" name="end-time" required>
        </div>
        
       
        <button class="btn btn-primary mt-2"  type="submit">Ajouter Créneau</button>
    </form>
    <div id="time-slots-container"></div>
</div>

</div>


<script>

    document.addEventListener('DOMContentLoaded', function () {
        const dateForm = document.getElementById('date-form');
        const timeSlotForm = document.getElementById('time-slot-form');
        const datesContainer = document.getElementById('dates-container');
        const timeSlotsContainer = document.getElementById('time-slots-container');
        const dateIdInput = document.getElementById('date-id');
        const getUrl = 'http://127.0.0.1:8000'; // cette url doit changer en ligne de production

        dateForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const date = dateForm.date.value;
            addDate(date);
        });

        timeSlotForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const dateId = dateIdInput.value;
            const startTime = timeSlotForm['start-time'].value;
            const endTime = timeSlotForm['end-time'].value;
            console.log('Adding time slot for date ID:', dateId);
            addTimeSlot(dateId, startTime, endTime);
        });

        function addDate(date) {
            fetch(`${getUrl}/admin/disponibilite/new`, {
                method: 'POST',
                body: JSON.stringify({ date: date }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dateElement = document.createElement('div');
                        dateElement.className = 'date';
                        dateElement.textContent = date;
                        dateElement.addEventListener('click', function () {
                            dateIdInput.value = data.id;
                            console.log('Selected date ID:', data.id);
                            loadTimeSlots(data.id);
                        });
                        datesContainer.appendChild(dateElement);
                    } else {
                        console.error('Error adding date:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function loadTimeSlots(dateId) {
            fetch(`${getUrl}/admin/disponibilite/date/${dateId}/time_slots`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    timeSlotsContainer.innerHTML = ''; // Clear previous time slots
                    if (data.success) {
                        data.time_slots.forEach(slot => {
                            const slotElement = document.createElement('div');
                            slotElement.className = 'time-slot';
                            slotElement.innerHTML = `
                            ${slot.start_time} - ${slot.end_time}
                           
                        `;
                            timeSlotsContainer.appendChild(slotElement);
                        });
                    } else {
                        console.error('Error loading time slots:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function addTimeSlot(dateId, startTime, endTime) {
            fetch(`${getUrl}/admin/disponibilite/time_slots/new`, {
                method: 'POST',
                body: JSON.stringify({
                    date_id: dateId,
                    start_time: startTime,
                    end_time: endTime
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const slotElement = document.createElement('div');
                        slotElement.className = 'time-slot';
                        slotElement.innerHTML = `
                        ${startTime} - ${endTime}
                       
                    `;
                        timeSlotsContainer.appendChild(slotElement);
                    } else {
                        console.error('Error adding time slot:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        

       
    });



</script>

{% endblock %}